{
	"name": "SProcedure_GoldDim_Products",
	"properties": {
		"content": {
			"query": "\n----Upsert Logic for Dim_Products\n\n----Need to continue working on these SP and make them clean and clear \n----SELECT * FROM GoldDim_Products;\n\n\n\nIF OBJECT_ID('dbo.usp_Merge_GoldDim_Products_ByDate', 'P') IS NOT NULL\n    DROP PROCEDURE dbo.usp_Merge_GoldDim_Products_ByDate;\nGO\n\nCREATE PROCEDURE usp_Merge_GoldDim_Products_ByDate\n    @Year NVARCHAR(4),\n    @Month NVARCHAR(2),\n    @Day NVARCHAR(2)\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    DECLARE @Location NVARCHAR(200) = \n        CONCAT('silver/dim_product/', @Year, '/', @Month, '/', @Day, '/');\n\n    DECLARE @sql NVARCHAR(MAX) = '\n    CREATE EXTERNAL TABLE ExternalGoldDimProductsTemp (\n        StockCode VARCHAR(100),\n        Description VARCHAR(100)\n    )\n    WITH (\n        LOCATION = ''' + @Location + ''',\n        DATA_SOURCE = SilverDataLake,\n        FILE_FORMAT = ParquetFormat\n    );\n\n    MERGE GoldDim_Products AS tgt\n    USING (\n        SELECT StockCode, Description\n        FROM (\n            SELECT \n                StockCode,\n                Description,\n                ROW_NUMBER() OVER (PARTITION BY StockCode ORDER BY Description) AS rn\n            FROM ExternalGoldDimProductsTemp\n            WHERE StockCode IS NOT NULL\n        ) AS dedup\n        WHERE rn = 1\n    ) AS src\n    ON tgt.StockCode = src.StockCode\n    WHEN MATCHED THEN\n        UPDATE SET\n            tgt.Description = src.Description\n    WHEN NOT MATCHED BY TARGET THEN\n        INSERT (StockCode, Description)\n        VALUES (src.StockCode, src.Description);\n\n    DROP EXTERNAL TABLE ExternalGoldDimProductsTemp;\n    ';\n\n    EXEC sp_executesql @sql;\nEND;\nGO\n\n---EXEC usp_Merge_GoldDim_Products_ByDate\n    --@Year = '2025',\n    --@Month = '08',\n    --@Day = '13';\n\n\n\n----SELECT * FROM GoldDim_Products\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "synape_sql_pool",
				"poolName": "synape_sql_pool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}